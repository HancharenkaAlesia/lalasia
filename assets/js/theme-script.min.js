
document.addEventListener('DOMContentLoaded', function () {

	if (document.querySelector('.sort')) {
		let sortBtn = document.querySelector('.sort__btn');
		let sortPopup = document.querySelector('.sort__popup');

		sortBtn.addEventListener('click', () => {
			sortPopup.classList.toggle('_visible');
			sortBtn.classList.toggle('_active');
		});

		document.addEventListener('click', (e) => {
			if (e.target.closest('.sort') != document.querySelector('.sort')) {
				sortPopup.classList.remove('_visible');
			}
		})
	}

	if (document.querySelector('.filter')) {
		let filterBtn = document.querySelector('.filter__button');
		let filterPopup = document.querySelector('.filter__popup');

		filterBtn.addEventListener('click', (e) => {
			e.preventDefault();
			filterPopup.classList.toggle('_visible');
			filterBtn.classList.toggle('_active');
		});

		document.addEventListener('click', (e) => {
			if (e.target.closest('.filter') != document.querySelector('.filter')) {
				filterPopup.classList.remove('_visible');
			}
		})
	}

	if (document.querySelector('.minicart')) {
		let minicart = document.querySelector('.minicart');
		let minicartClose = document.querySelector('.minicart__close');
		let minicartOpen = document.querySelector('.header__cart');
		let body = document.querySelector('body');

		minicartOpen.addEventListener('click', () => {
			body.classList.add('_minicart-open');
		});


		minicartClose.addEventListener('click', () => {
			body.classList.remove('_minicart-open');
		});

		document.addEventListener('click', (e) => {
			if (e.target.classList.contains('minicart__layout')) {
				body.classList.remove('_minicart-open');
			}
		})
	}

	/* range */

	if (document.querySelector('.filter__range')) {
		const rangeInput = document.querySelectorAll(".range__input input");
		const range = document.querySelector(".range__progress");
		const priceInput = document.querySelectorAll(".range__price-input input");
		let priceGap = 1;

		priceInput.forEach(input => {
			input.addEventListener("input", e => {
				let minPrice = parseInt(priceInput[0].value),
					maxPrice = parseInt(priceInput[1].value);

				if ((maxPrice - minPrice >= priceGap) && maxPrice <= rangeInput[1].max) {
					if (e.target.className === "input-min") {
						rangeInput[0].value = minPrice;
						range.style.left = ((minPrice / rangeInput[0].max) * 100 - 3) + "%";
					} else {
						rangeInput[1].value = maxPrice;
						range.style.right = 103 - (maxPrice / rangeInput[1].max) * 100 + "%";
					}
				}
			});
		});

		rangeInput.forEach(input => {
			input.addEventListener("input", e => {
				let minVal = parseInt(rangeInput[0].value),
					maxVal = parseInt(rangeInput[1].value);
				if ((maxVal - minVal) < priceGap) {
					if (e.target.className === "range-min") {
						rangeInput[0].value = maxVal - priceGap
					} else {
						rangeInput[1].value = minVal + priceGap;
					}
				} else {
					priceInput[0].value = minVal;
					priceInput[1].value = maxVal;
					range.style.left = ((minVal / rangeInput[0].max) * 100 - 3) + "%";
					range.style.right = 103 - (maxVal / rangeInput[1].max) * 100 + "%";
				}

				filtersForm.dispatchEvent(new Event('submit'));
			});
		});
	}

	//сортировка

	if (document.querySelector('.products__catalog')) {
		let sortItems = document.querySelectorAll('.sort__item');
		let sortHiddenInput = document.querySelector('.filter__sort');
		let filtersForm = document.querySelector('#filters-form');
		let sortProductsGrid = document.querySelector('.catalog__grid');
		let sortCategories = document.querySelectorAll('.filter__list input');
		let productsPagination = document.querySelector('.catalog__pagination');
		let productsQuantity = document.querySelector('.catalog__total');
		let productSearch = document.querySelector('.search__input input');
		let pageNumber = 1;
		let productSearchStr = '';

		sortCategories.forEach(sortCategory => {
			sortCategory.addEventListener('change', e => {
				pageNumber = 1;
				filtersForm.dispatchEvent(new Event('submit'));
			});
		});

		sortItems.forEach(sortLink => {
			sortLink.addEventListener('click', (e) => {
				e.preventDefault();

				let selectedSortValue = sortLink.getAttribute("href").replace('?orderby=', '');

				//sortHiddenInput.value = selectedSortValue;
				sortHiddenInput.setAttribute('value', selectedSortValue);

				sortItems.forEach(sortLink => {
					sortLink.classList.remove('_active');
				});

				sortLink.classList.add('_active');

				pageNumber = 1;

				filtersForm.dispatchEvent(new Event('submit'));

			});
		});


		jQuery(productSearch).autocomplete({
			source: function (request, response) {
				pageNumber = 1;
				productSearchStr = request.term;

				/* jQuery.ajax({
					url: woocommerce_params.ajax_url, // URL ajax-запроса, /wp-admin/admin-ajax.php
					data: {
						action: 'mywebsitesearch',
						term: request.term // поисковой запрос
					},
					success: function (data) {
						console.log(data);
						response(data);
					}
				}); */

				filtersForm.dispatchEvent(new Event('submit'));
			},
			select: function (event, ui) {
				window.location = ui.item.url;
			}
		});

		productSearch.addEventListener('input', () => {
			if (productSearch.value == '') {
				pageNumber = 1;
				productSearchStr = '';
				filtersForm.dispatchEvent(new Event('submit'));
			}
		});

		jQuery('body').on('click', '.page-numbers', function (event) {
			event.preventDefault();

			if (jQuery(this).hasClass('current')) {
				return;
			};

			pageNumber = jQuery(this).text();

			filtersForm.dispatchEvent(new Event('submit'));
		})


		jQuery('#filters-form').submit(function (event) {
			event.preventDefault();

			const form = jQuery(this).serialize();
			let formStr = form + `&paged=${pageNumber}` + `&term=${productSearchStr}`;

			jQuery.ajax({
				type: "POST",
				url: woocommerce_params.ajax_url,
				data: formStr,
				beforeSend: function (xhr) {
					jQuery('.catalog').block({
						message: null,
						overlayCSS: {
							background: '#ffffff',
							opacity: 0.6,
						}
					});
				},

				success: function (data) {

					jQuery(sortProductsGrid).html(data.products);
					jQuery(productsQuantity).html(data.count);
					jQuery('.catalog__pagination').html(data.pagination);

					//console.log(formStr);

					jQuery('.catalog').unblock();
				},

				error: function (error) {
					console.log(error);
				}
			});

		});
	}

	if (document.querySelector('.projects')) {
		(function ($) {
			$('.projects__filter').on('click', '.projects__button:not(._active)', function () {
				$(this).addClass('_active').siblings().removeClass('_active');
			});

			let paged = 2;

			$(document).on("click", ".projects__more, .projects__button", function (e) {
				e.preventDefault();

				let cat
				let new_data;
				if ($('.projects__button._active').attr('data-cat')) {
					cat = $('.projects__button._active').attr('data-cat');
				} else {
					cat = '';
				}

				if ($(e.target).hasClass('projects__button')) {
					paged = 1;
				}

				if ($(e.target).hasClass('projects__more')) {
					new_data = false;
				} else {
					new_data = true;
				}

				let objTable = {
					action: 'blog_filter',
					paged,
					cat,
					new_data,
					security: script_data_array.security,
				};

				console.log(objTable);

				$.ajax({
					url: script_data_array.ajaxurl,
					type: "POST",
					data: objTable,
					beforeSend: function (xhr) {
						jQuery('.projects__wrapper').block({
							message: null,
							overlayCSS: {
								background: '#ffffff',
								opacity: 0.6,
							}
						});
					},
					success: function (response) {
						response = JSON.parse(response);
						if (response['status'] == 'success' && $(e.target).hasClass('projects__more')) {
							$('.projects__wrapper').append(response['data']);
							paged++;
						} else if (response['status'] == 'success') {
							$('.projects__wrapper').html(response['data']);
							paged++;
						}

						if (response['more_btn']) {
							$('.projects__more').hide();
						} else {
							$('.projects__more').show();
						}

						jQuery('.projects__wrapper').unblock();
					},
					error: function (error) {
						alert("Error!");
					}
				});

			});

		})(jQuery)
	}

});
